/*
 * display.c
 *
 *  Created on: Nov 25, 2021
 *      Author: adityasehgal
 */

#include <stdio.h>

#include "cmsis_os.h"
#include "display.h"
#include "analog.h"
#include "power.h"

#define	INFO_X 2
#define ON_OFF_X 105
#define	VIN_Y 0
#define	VSET_Y 12
#define	VOUT_Y 24
#define	ISET_Y 36
#define	IOUT_Y 48

#define INFO_TEXT_SIZE Font_7x10
#define ERROR_TEXT_SIZE Font_11x18

osThreadId oledTask_Handle;

const uint8_t BOOTSCREEN[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x07, 0xe0, 0xff, 0xc0, 0x0f, 0xe1, 0xff, 0xef, 0xc7, 0xe0, 0xff,
		0x00, 0x7c, 0x0f, 0xc0, 0x00, 0x1f, 0xe1, 0xff, 0xf0, 0x7f, 0xff, 0xff,
		0xff, 0xcf, 0xe3, 0xff, 0xc1, 0xfe, 0x1f, 0xe0, 0x00, 0x18, 0xe1, 0x80,
		0x3c, 0xc0, 0x3f, 0x00, 0xf9, 0xcc, 0x6e, 0x01, 0xe3, 0x8e, 0x18, 0xc0,
		0x00, 0x30, 0x71, 0x80, 0x1f, 0xc3, 0x3e, 0x00, 0xf9, 0xcc, 0xfc, 0x00,
		0xe3, 0x0e, 0x39, 0xc0, 0x00, 0x30, 0x73, 0x8f, 0x8f, 0x8f, 0xf6, 0x3f,
		0xf9, 0x9c, 0xf8, 0x7e, 0xc7, 0x07, 0x39, 0xc0, 0x00, 0x63, 0x73, 0x98,
		0x4f, 0x9d, 0xfe, 0x7f, 0xb9, 0xfc, 0xf1, 0xff, 0x86, 0x37, 0x39, 0xc0,
		0x00, 0xc7, 0x73, 0x90, 0x67, 0x9f, 0xce, 0x7f, 0xf3, 0xf8, 0xf3, 0x87,
		0x0e, 0xf7, 0x31, 0xc0, 0x01, 0xcf, 0x33, 0x10, 0x67, 0xc3, 0xec, 0x01,
		0xf0, 0x00, 0xf3, 0x8f, 0xdc, 0xf7, 0x31, 0x80, 0x01, 0x8b, 0x3b, 0x30,
		0x67, 0xe0, 0xfc, 0x03, 0xf0, 0x01, 0xf3, 0x9f, 0xd9, 0xb3, 0x73, 0x80,
		0x03, 0x9f, 0x3f, 0x30, 0xc6, 0xfe, 0x7c, 0x7f, 0xf1, 0xf9, 0xf3, 0x99,
		0xf9, 0xf3, 0xf3, 0x80, 0x03, 0x00, 0x3f, 0x31, 0x8f, 0xff, 0x3c, 0xff,
		0x73, 0xf9, 0xf3, 0xb9, 0xf0, 0x03, 0xf3, 0x80, 0x06, 0x00, 0x3f, 0x3f,
		0x0f, 0xfe, 0x3c, 0xff, 0xe7, 0x39, 0xf3, 0xf9, 0xe0, 0x03, 0xe3, 0xfe,
		0x0e, 0x3f, 0x9f, 0x3c, 0x1f, 0xfc, 0x78, 0xff, 0xe7, 0x31, 0xb8, 0xf1,
		0xe3, 0xfb, 0xe3, 0xfe, 0x0c, 0x7f, 0x9e, 0x00, 0x3f, 0x00, 0x78, 0x03,
		0xe7, 0x33, 0xbc, 0x03, 0xc7, 0xf9, 0xe0, 0x0e, 0x1f, 0xe1, 0xff, 0xff,
		0xf7, 0xc1, 0xff, 0xff, 0xff, 0x3f, 0x9f, 0x07, 0xfe, 0x3f, 0xff, 0xfc,
		0x3f, 0xc1, 0xff, 0xff, 0xc7, 0xff, 0xbf, 0xff, 0xfe, 0x7f, 0x8f, 0xff,
		0xfc, 0x3f, 0xff, 0xfc, 0x1f, 0x81, 0xff, 0xfc, 0x00, 0xfe, 0x1f, 0xfe,
		0xfc, 0x3e, 0x03, 0xf1, 0xf0, 0x1f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

static void oledTask(void const *argument);

static uint32_t calcVSetFromPot(uint8_t pot);

static void setupVin(stats_t stats);

static void setupVset(stats_t stats);

static void setupVout(stats_t stats);

static void setupIset(stats_t stats);

static void setupIout(stats_t stats);

static void setupOnOff(stats_t stats);

static void display_startUpScreen(void);

void oledTask(void const *argument) {
	ssd1306_init();
	display_startUpScreen();
	osDelay(2000);
	stats_t stats;

	for (;;) {

		analog_updateStats(&stats);
		power_updateStats(&stats);
		display_showStats(stats);
		osDelay(100);
	}

	osThreadTerminate(osThreadGetId());
}

uint32_t calcVSetFromPot(uint8_t pot) {

	double potCalc = (((double) pot / 128.0)) * 5000.0;
	double temp = 800.0 * ((5000.0 / potCalc) + 1.0);
	return (uint32_t) (temp);

}

void setupVin(stats_t stats) {

	char buff[10] = { };

	//Display voltage in
	ssd1306_setCursor(INFO_X, VIN_Y);
	ssd1306_writeString("Vin  = ", INFO_TEXT_SIZE, SSD1306_WHITE);
	if (stats.Vin > 1000) {
		sprintf(buff, "%4.2f", stats.Vin / 1000);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		ssd1306_writeString("V", INFO_TEXT_SIZE, SSD1306_WHITE);
	} else {
		sprintf(buff, "%4.2f", stats.Vin);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		ssd1306_writeString("mV", INFO_TEXT_SIZE, SSD1306_WHITE);
	}

}

void setupVset(stats_t stats) {
	char buff[10] = { };
	//display set voltage
	ssd1306_setCursor(INFO_X, VSET_Y);
	ssd1306_writeString("Vset = ", INFO_TEXT_SIZE, SSD1306_WHITE);

	uint32_t vSet = calcVSetFromPot(stats.vSet);

	if (vSet >= 1000) {
		sprintf(buff, "%4.2f", (double) vSet / 1000.0);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		if (stats.selVI == VI_V_SEL)
			ssd1306_writeString("V <<", INFO_TEXT_SIZE, SSD1306_WHITE);
		else
			ssd1306_writeString("V     ", INFO_TEXT_SIZE, SSD1306_WHITE);
	} else {
		sprintf(buff, "%4.2f", (double) vSet);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		if (stats.selVI == VI_V_SEL)
			ssd1306_writeString("mV <<", INFO_TEXT_SIZE, SSD1306_WHITE);
		else
			ssd1306_writeString("mV     ", INFO_TEXT_SIZE, SSD1306_WHITE);
	}
}

void setupVout(stats_t stats) {
	char buff[10] = { };
	//display output voltage
	ssd1306_setCursor(INFO_X, VOUT_Y);
	ssd1306_writeString("Vout = ", INFO_TEXT_SIZE, SSD1306_WHITE);
	if (stats.Vout >= 1000) {
		sprintf(buff, "%4.2f", stats.Vout / 1000.0);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		ssd1306_writeString("V", INFO_TEXT_SIZE, SSD1306_WHITE);
	} else {
		sprintf(buff, "%4.2f", stats.Vout);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		ssd1306_writeString("mV", INFO_TEXT_SIZE, SSD1306_WHITE);
	}
}

void setupIset(stats_t stats) {
	char buff[10] = { };
	//display set current
	ssd1306_setCursor(INFO_X, ISET_Y);
	ssd1306_writeString("Iset = ", INFO_TEXT_SIZE, SSD1306_WHITE);
	if (stats.iSet >= 1000) {
		sprintf(buff, "%4.2f", (double) stats.iSet / 1000.0);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		if (stats.selVI == VI_I_SEL)
			ssd1306_writeString("A <<", INFO_TEXT_SIZE, SSD1306_WHITE);
		else
			ssd1306_writeString("A     ", INFO_TEXT_SIZE, SSD1306_WHITE);
	} else {
		sprintf(buff, "%4.2f", (double) stats.iSet);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		if (stats.selVI == VI_I_SEL)
			ssd1306_writeString("mA <<", INFO_TEXT_SIZE, SSD1306_WHITE);
		else
			ssd1306_writeString("mA     ", INFO_TEXT_SIZE, SSD1306_WHITE);
	}
}

void setupIout(stats_t stats) {
	char buff[10] = { };
	//display output current
	ssd1306_setCursor(INFO_X, IOUT_Y);
	ssd1306_writeString("Iout = ", INFO_TEXT_SIZE, SSD1306_WHITE);
	if (stats.Iout >= 1000) {
		sprintf(buff, "%4.2f", stats.Iout / 1000.0);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		ssd1306_writeString("A", INFO_TEXT_SIZE, SSD1306_WHITE);
	} else {
		sprintf(buff, "%4.2f", stats.Iout);
		ssd1306_writeString(buff, INFO_TEXT_SIZE, SSD1306_WHITE);
		ssd1306_writeString("mA", INFO_TEXT_SIZE, SSD1306_WHITE);
	}
}

void setupOnOff(stats_t stats) {
	//display whether PSU output is enabled
	ssd1306_setCursor(ON_OFF_X, VIN_Y);
	if (stats.outputEn == OE_ENABLED)
		ssd1306_writeString("ON   ", INFO_TEXT_SIZE, SSD1306_WHITE);
	else
		ssd1306_writeString("OFF", INFO_TEXT_SIZE, SSD1306_WHITE);
}

void display_startUpScreen(void) {
	ssd1306_drawBitMap(0, 0, BOOTSCREEN, 128, 32, SSD1306_WHITE);
	ssd1306_updateScreen();
}

void display_init(void) {
	osThreadDef(oledTask_, oledTask, osPriorityNormal, 0, 512);
	oledTask_Handle = osThreadCreate(osThread(oledTask_), NULL);
}

void display_writeErrorMsg(int16_t x, int16_t y, char *str) {

}

void display_showStats(stats_t stats) {
	ssd1306_fill(SSD1306_BLACK);
	setupVin(stats);
	setupVout(stats);
	setupVset(stats);
	setupIout(stats);
	setupIset(stats);
	setupOnOff(stats);

	ssd1306_updateScreen();
}

